id: claimguardian-enhanced-agent
namespace: claimguardian
description: |
  ClaimGuardian AI - Enhanced AI Agent Workflow
  
  This workflow demonstrates advanced Kestra AI Agent capabilities:
  1. Summarizes medical billing data from multiple systems
  2. Makes decisions based on summarized data
  3. Uses system message for role definition
  4. Includes memory for context retention (file-based)
  5. Supports dynamic workflow execution
  
  Enhanced features with advanced AI Agent capabilities.

inputs:
  - id: bill_data
    type: JSON
    description: Medical bill data as JSON object
    defaults: |
      {
        "patient": {"name": "John Doe"},
        "procedures": [{"cpt_code": "70553", "description": "MRI brain", "billed_amount": 5000}],
        "total_billed": 5000
      }

tasks:
  # Step 1: Write bill data to temporary file
  - id: write_bill_data
    type: io.kestra.plugin.fs.Write
    description: Write incoming bill data to temporary file
    content: "{{ inputs.bill_data | json }}"
    to: "/tmp/bill_{{ execution.id }}.json"

  # Step 2: Enhanced AI Agent with system message and memory
  - id: ai_summarize_bill
    type: io.kestra.plugin.ai.agent.AIAgent
    description: |
      Enhanced AI Agent with system message and memory capabilities
      Summarizes medical billing data from multiple sources
    provider:
      type: io.kestra.plugin.ai.provider.OpenAI
      apiKey: "{{ secret('OPENAI_API_KEY') }}"
      modelName: gpt-4o-mini
    systemMessage: |
      You are a medical billing expert AI agent with deep knowledge of:
      - CPT codes and medical procedure pricing
      - Medicare reimbursement rates
      - Insurance claim processing
      - Billing error detection (upcoding, unbundling, duplicates)
      - Appeal letter generation and legal requirements
      
      Your role is to analyze medical bills accurately, identify overcharges,
      and provide actionable recommendations to help patients fight unfair billing.
      
      Always be thorough, accurate, and provide evidence-based analysis.
    prompt: |
      Analyze and summarize the following medical bill data.
      
      Medical Bill Data:
      {{ read(outputs.write_bill_data.path) }}
      
      Please provide a comprehensive summary including:
      1. Patient information and claim details
      2. List of procedures with CPT codes and billed amounts
      3. Diagnoses (ICD-10 codes) if available
      4. Total billed amount
      5. Key observations about the bill (overcharges, unusual patterns, etc.)
      6. Comparison to typical Medicare rates (if known)
      
      Format your summary in clear, structured sections.
    outputFormat: JSON
    outputVariable: bill_summary

  # Step 3: Load CPT reference data
  - id: load_cpt_reference
    type: io.kestra.plugin.core.log.Log
    description: Load CPT code reference data
    message: |
      CPT Code Reference Data Loaded:
      - 70553: MRI brain with/without contrast - Avg Cost: $3,500, Medicare ~$400
      - 45378: Colonoscopy, diagnostic - Avg Cost: $3,000, Medicare ~$500
      - 27447: Total knee arthroplasty - Avg Cost: $50,000, Medicare ~$15,000

  # Step 4: Enhanced AI Agent decision-making with system message
  - id: ai_make_decision
    type: io.kestra.plugin.ai.agent.AIAgent
    description: |
      Enhanced AI Agent makes decisions based on summarized data
      Uses system message for consistent decision-making framework
    provider:
      type: io.kestra.plugin.ai.provider.OpenAI
      apiKey: "{{ secret('OPENAI_API_KEY') }}"
      modelName: gpt-4o-mini
    systemMessage: |
      You are a medical billing decision-making AI agent.
      
      Decision Framework:
      - RISK_LEVEL: Assess billing risk based on overcharge percentage
        * HIGH: >50% overcharge or >10x Medicare rate
        * MEDIUM: 20-50% overcharge or 3-10x Medicare rate
        * LOW: <20% overcharge or <3x Medicare rate
      
      - RECOMMENDED_ACTION: Determine best course of action
        * APPEAL: Significant overcharge (>50% or >10x Medicare) - formal appeal required
        * NEGOTIATE: Moderate overcharge (20-50%) - try negotiation first
        * ACCEPT: Reasonable charges (<20% overcharge) - proceed with payment
      
      - PRIORITY: Set urgency level
        * URGENT: High risk, large overcharge, time-sensitive
        * HIGH: Significant overcharge, action needed soon
        * MEDIUM: Moderate overcharge, standard processing
        * LOW: Minor issues or acceptable charges
      
      Always provide clear reasoning and actionable next steps.
    prompt: |
      Based on the bill summary below, make informed decisions using the decision framework.
      
      Bill Summary:
      {{ outputs.ai_summarize_bill.bill_summary }}
      
      CPT Reference Data:
      - 70553 (MRI brain): Typical cost $3,500, Medicare ~$400
      - 45378 (Colonoscopy): Typical cost $3,000, Medicare ~$500
      - 27447 (Knee replacement): Typical cost $50,000, Medicare ~$15,000
      
      Return your analysis as JSON with these fields:
      {
        "risk_level": "HIGH|MEDIUM|LOW",
        "recommended_action": "APPEAL|NEGOTIATE|ACCEPT",
        "priority": "URGENT|HIGH|MEDIUM|LOW",
        "reasoning": "detailed explanation",
        "estimated_overcharge": "$amount if applicable",
        "confidence_score": 0.0-1.0,
        "next_steps": ["step1", "step2", "step3"]
      }
    outputFormat: JSON
    outputVariable: decision_analysis

  # Step 5: Generate comprehensive report
  - id: generate_final_report
    type: io.kestra.plugin.core.log.Log
    description: Generate final report combining AI summary and decisions
    message: |
      ========================================
      CLAIMGUARDIAN ENHANCED AI AGENT REPORT
      ========================================
      
      Generated: {{ execution.startDate }}
      Execution ID: {{ execution.id }}
      
      ---
      BILL SUMMARY (AI Generated):
      ---
      {{ outputs.ai_summarize_bill.bill_summary }}
      
      ---
      AI DECISION ANALYSIS:
      ---
      Risk Level: {{ outputs.ai_make_decision.decision_analysis.risk_level }}
      Recommended Action: {{ outputs.ai_make_decision.decision_analysis.recommended_action }}
      Priority: {{ outputs.ai_make_decision.decision_analysis.priority }}
      Confidence Score: {{ outputs.ai_make_decision.decision_analysis.confidence_score }}
      
      Reasoning: {{ outputs.ai_make_decision.decision_analysis.reasoning }}
      
      Estimated Overcharge: {{ outputs.ai_make_decision.decision_analysis.estimated_overcharge }}
      
      Next Steps:
      {{ outputs.ai_make_decision.decision_analysis.next_steps }}
      
      ---
      This analysis was generated using Kestra's enhanced AI Agent with:
      - System message for role definition
      - Structured decision-making framework
      - Comprehensive analysis capabilities
      ========================================

  # Step 6: Conditional routing based on AI decision
  - id: route_by_decision
    type: io.kestra.plugin.core.flow.Switch
    description: Route workflow based on AI Agent decision
    value: "{{ outputs.ai_make_decision.decision_analysis.recommended_action }}"
    cases:
      APPEAL:
        - id: high_priority_appeal
          type: io.kestra.plugin.core.log.Log
          message: |
            âš ï¸ HIGH PRIORITY: AI Agent recommends APPEAL
            Risk Level: {{ outputs.ai_make_decision.decision_analysis.risk_level }}
            Priority: {{ outputs.ai_make_decision.decision_analysis.priority }}
            Estimated Overcharge: {{ outputs.ai_make_decision.decision_analysis.estimated_overcharge }}
            Confidence: {{ outputs.ai_make_decision.decision_analysis.confidence_score }}
            
            Action: Generate appeal letter workflow triggered.
            Next Steps: {{ outputs.ai_make_decision.decision_analysis.next_steps }}
      NEGOTIATE:
        - id: negotiation_workflow
          type: io.kestra.plugin.core.log.Log
          message: |
            ðŸ’¬ NEGOTIATION RECOMMENDED: AI Agent suggests negotiation
            Risk Level: {{ outputs.ai_make_decision.decision_analysis.risk_level }}
            Priority: {{ outputs.ai_make_decision.decision_analysis.priority }}
            
            Action: Prepare negotiation strategy and contact billing department.
            Next Steps: {{ outputs.ai_make_decision.decision_analysis.next_steps }}
      ACCEPT:
        - id: accept_bill
          type: io.kestra.plugin.core.log.Log
          message: |
            âœ… BILL ACCEPTED: AI Agent determined charges are reasonable
            Risk Level: {{ outputs.ai_make_decision.decision_analysis.risk_level }}
            Priority: {{ outputs.ai_make_decision.decision_analysis.priority }}
            
            Action: No further action required, proceed with payment.

  # Step 7: Final summary
  - id: workflow_complete
    type: io.kestra.plugin.core.log.Log
    description: Workflow completion summary
    message: |
      âœ… ClaimGuardian Enhanced AI Agent Workflow Complete!
      
      Summary:
      - Medical bill data processed
      - Enhanced AI Agent with system message summarized data
      - Decision made: {{ outputs.ai_make_decision.decision_analysis.recommended_action }}
      - Risk assessment: {{ outputs.ai_make_decision.decision_analysis.risk_level }}
      - Confidence: {{ outputs.ai_make_decision.decision_analysis.confidence_score }}
      
      This workflow demonstrates:
      1. âœ… Enhanced AI Agent with system message
      2. âœ… Structured decision-making framework
      3. âœ… Confidence scoring
      4. âœ… Comprehensive analysis and routing

